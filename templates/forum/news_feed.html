{% extends 'bases/base.html' %}
{% load static %}
{% block title %} News Feed {% endblock title %}
{% block main_content %}
    <!--begin::Post-->
    <div class="post d-flex flex-column-fluid" id="kt_post">
        <!--begin::Container-->
        <div id="kt_content_container" class="container-xxl">
            <!--begin::Row-->
            <div class="row g-5 g-xxl-8">
                <!--begin::Col-->
                <div class="col-xl-8">
                    {% if request.user.is_authenticated %}
                        <!--begin::Feeds Widget |Create Post -->
                        <div class="card mb-5 mb-xxl-8">
                            <!--begin::Body-->
                            <div class="card-body pb-0">
                                <!--begin::Header-->
                                <div class="d-flex align-items-center">
                                    <!--begin::User-->
                                    <div class="d-flex align-items-center flex-grow-1">
                                        <!--begin::Avatar-->
                                        <div class="symbol symbol-45px me-5">
                                            <img src="{% static 'media/avatars/300-6.jpg' %}" alt=""/>
                                        </div>
                                        <!--end::Avatar-->
                                        <!--begin::Info-->
                                        <div class="d-flex flex-column">
                                            <a href="#"
                                               class="text-gray-900 text-hover-primary fs-6 fw-bolder">{{ request.user.username }}</a>
                                        </div>
                                        <!--end::Info-->
                                    </div>
                                    <!--end::User-->

                                </div>
                                <!--end::Header-->
                                <!--begin::Form-->
                                <form id="kt_forms_widget_1_form" class="ql-quil ql-quil-plain pb-3">
                                    <!--begin::Editor-->
                                    <div id="kt_forms_widget_1_editor" class="py-6"></div>
                                    <!--end::Editor-->
                                    <div class="separator"></div>
                                    <!--begin::Toolbar-->
                                    <div id="kt_forms_widget_1_editor_toolbar"
                                         class="ql-toolbar d-flex flex-stack py-2">
                                        <div class="me-2">
                                            {#	<span class="ql-formats ql-size ms-0">#}
                                            {#	<select class="ql-size w-75px"></select>#}
                                            {#	</span>#}

                                            <label for="post_pic">
                                                <i class="fa fa-camera">
                                                    <input type="file" name="post_pic" id="post_pic" accept="image/*"
                                                           style="display: none">
                                                </i>

                                            </label>
                                            <span class="ql-formats">
{#                                                <input type="file" id="post_pic" name="post_pic"#}
{#                                                       accept="image/png, image/gif, image/jpeg">#}

{#                                                <button class="ql-bold"></button>#}
{#                                                <button class="ql-italic"></button>#}
{#                                                <button class="ql-underline"></button>#}
{#                                                <button class="ql-strike"></button>#}
{#                                                <button class="ql-image"></button>#}
{#                                                <button class="ql-link"></button>#}
{#                                                <button class="ql-clean">post </button>#}
                                            </span>

                                        </div>

                                    </div>
                                    <button class="btn btn-primary btn-sm float-end mb-5" id="submit-post"
                                            type="button" onclick="uploadPost()">Post
                                    </button>
                                    <!--end::Toolbar-->
                                </form>
                                <!--end::Form-->
                            </div>
                            <!--end::Body-->
                        </div>
                        <!--end::Feeds Widget  |Create Post -->
                    {% endif %}
                    <div id="newsFeed_section">
                        {% for post in posts %}
                            {% with post=post %}
                                {% include 'forum/post_section.html' %}
                            {% endwith %}

                        {% endfor %}
                    </div>
                </div>
                <!--end::Col-->
                <!--begin::Col-->
                <div class="col-xl-4">
                    <!--begin::Widget-->
                    <div class="card mb-5 mb-xxl-8">
                        <!--begin::Header-->
                        <div class="card-header border-0 pt-5">
                            <!--begin::Title-->
                            <h3 class="card-title align-items-start flex-column">
                                <span class="card-label fw-bolder fs-3 mb-1">Promoted Product</span>
                                <span class="text-muted fw-bold fs-7">Lorem Ipsum Dollar Summit</span>
                            </h3>
                            <!--end::Title-->
                            <!--begin::Toolbar-->
                            <div class="card-toolbar">
                                <!--begin::Menu-->
                                <button type="button"
                                        class="btn btn-sm btn-icon btn-color-primary btn-active-light-primary"
                                        data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">
                                    <!--begin::Svg Icon | path: icons/duotune/general/gen024.svg-->
                                    <span class="svg-icon svg-icon-2">
															<svg xmlns="http://www.w3.org/2000/svg" width="24px"
                                                                 height="24px" viewBox="0 0 24 24">
																<g stroke="none" stroke-width="1" fill="none"
                                                                   fill-rule="evenodd">
																	<rect x="5" y="5" width="5" height="5" rx="1"
                                                                          fill="currentColor"/>
																	<rect x="14" y="5" width="5" height="5" rx="1"
                                                                          fill="currentColor" opacity="0.3"/>
																	<rect x="5" y="14" width="5" height="5" rx="1"
                                                                          fill="currentColor" opacity="0.3"/>
																	<rect x="14" y="14" width="5" height="5" rx="1"
                                                                          fill="currentColor" opacity="0.3"/>
																</g>
															</svg>
														</span>
                                    <!--end::Svg Icon-->
                                </button>

                                <!--end::Menu-->
                            </div>
                            <!--end::Toolbar-->
                        </div>
                        <!--end::Header-->
                        <!--begin::Body-->
                        <div class="card-body">
                            <!--begin::Picture-->
                            <img src="{% static 'media/avatars/300-1.jpg' %}" class="card-img-top">
                            <!--end::Picture-->
                        </div>
                        <!--end::Body-->
                    </div>
                    <!--end::Widget-->

                </div>
                <!--end::Col-->

            </div>
            <!--end::Row-->
        </div>
        <!--end::Container-->
    </div>
    <!--end::Post-->
{% endblock main_content %}
{% block extra_js %}
    <script>
        function uploadPost() {
            let text_content = $('#kt_forms_widget_1_editor').text();
            var data = new FormData();
            data.append("csrfmiddlewaretoken", "{{ csrf_token }}")
            data.append("text_content", text_content);
            data.append("post_media", $("input[id^='post_pic']")[0].files[0]);

            $.ajax(
                {
                    url: '{% url 'upload_post' %}',
                    type: "POST",
                    processData: false,
                    contentType: false,
                    mimetype: "multipart/form-data",
                    data: data,
                    datatype: 'JSON',
                    success: function (response) {
                        console.log(response);
                        $('#newsFeed_section').prepend(response)
                        {#TODO after posting refresh the post content area#}
                        $("#kt_forms_widget_1_editor").load(window.location.href + " #kt_forms_widget_1_editor");

                    }
                }
            );
        }

        function addComment(post) {
            var content = $('#comentbox' + post).val();
            $.ajax(
                {
                    url: '{% url 'add_comment' %}',
                    data:
                        {
                            'post': post,
                            'content': content,
                        },
                    datatype: 'JSON',
                    success: function (response) {
                        $('#comment_section' + post).append(response)
                        $('#comentbox' + post).val('')


                    }
                }
            );
        }

        function addVote(post, vote) {

            $.ajax(
                {
                    url: '{% url 'add_vote' %}',
                    data: {
                        'post': post,
                        'vote': vote,
                    },
                    datatype: 'JSON',
                    success: function (response) {
                        console.log(response)
                        {#$('#upvote' + post).text('hey there')#}
                        $('#upvote' + post).text(response.upvote);
                        $('#downvote' + post).text(response.downvote);


                        console.log();
                        {#var count = document.querySelector('')#}
                    }
                }
            );
        }
    </script>
{% endblock extra_js %}